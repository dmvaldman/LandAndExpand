<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Annotated Meltdown</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked-footnote/dist/index.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Share Tech Mono', monospace;
        }
        #annotation-popup {
            transition: opacity 0.2s ease-in-out;
        }
        /* Style for the footnote references generated by marked.js */
        a[data-footnote-ref] {
            background-color: rgba(250, 204, 21, 0.2);
            color: #facc15;
            cursor: pointer;
            padding: 2px 5px;
            border-radius: 4px;
            transition: background-color 0.2s ease;
            text-decoration: none;
            font-size: 0.8em;
        }
        a[data-footnote-ref]:hover {
            background-color: rgba(250, 204, 21, 0.4);
        }
        #annotation-popup a {
            color: #facc15;
            text-decoration: underline;
            transition: color 0.2s ease;
        }
        #annotation-popup a:hover {
            color: #fde047;
        }
        /* Style for Markdown blockquotes */
        blockquote {
            border-left: 3px solid rgba(255, 255, 255, 0.3);
            padding-left: 24px;
            margin-left: 16px;
            font-style: italic;
            background-color: rgba(255, 255, 255, 0.02);
            padding-top: 12px;
            padding-bottom: 12px;
            border-radius: 4px;
        }
        /* Style for Markdown headings */
        #content-container h2, #content-container h3, #content-container h4 {
            font-weight: 700; /* font-bold */
            color: #facc15; /* text-yellow-400 */
        }
        #content-container h2 {
            font-size: 1.875rem; /* text-3xl */
            margin-top: 2.5rem; /* mt-10 */
            margin-bottom: 1.25rem; /* mb-5 */
        }
        #content-container h3 {
            font-size: 1.5rem; /* text-2xl */
            margin-top: 2rem; /* mt-8 */
            margin-bottom: 1rem; /* mb-4 */
        }
        #content-container h4 {
            font-size: 1.25rem; /* text-xl */
            margin-top: 1.5rem; /* mt-6 */
            margin-bottom: 0.75rem; /* mb-3 */
        }
        /* Hide the actual footnote list at the bottom */
        .footnotes {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-300">

    <!-- <div id="annotation-popup" class="hidden fixed bg-gray-900 border border-yellow-500/50 text-white p-4 rounded-lg shadow-2xl text-base z-50 transition-opacity duration-200 w-[90vw] sm:w-auto sm:max-w-sm md:max-w-md"></div> -->

    <div class="max-w-4xl mx-auto p-4 sm:p-8">
        <header class="text-center mb-12">
            <h1 id="content-title" class="text-4xl sm:text-5xl font-bold text-yellow-400 tracking-wider"></h1>
            <p id="content-author" class="text-gray-400 mt-2"></p>
            <p id="content-meta" class="text-gray-500 mt-4 text-sm"></p>
        </header>

        <main id="content-container" class="space-y-6 text-lg leading-relaxed sm:leading-loose">
            <!-- Content will be injected here by JavaScript -->
        </main>
    </div>

    <!-- Annotation Popup -->
    <div id="annotation-popup" class="hidden absolute z-50 p-4 bg-gray-800 border border-yellow-400 rounded-lg shadow-2xl text-base leading-relaxed w-[90vw] sm:w-auto sm:max-w-sm md:max-w-md">
        <!-- Annotation content will be injected here -->
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const contentContainer = document.getElementById('content-container');
            const popup = document.getElementById('annotation-popup');
            let hideTimeout;
            let isTouchDevice = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);

            async function loadAndRenderMarkdown() {
                try {
                    const response = await fetch('docs/meltdown.md');
                    if (!response.ok) throw new Error('Network response failed.');
                    let rawText = await response.text();

                    const frontMatter = parseFrontMatter(rawText);

                    if (frontMatter.metadata) {
                        document.getElementById('content-title').textContent = frontMatter.metadata.Title.toUpperCase();
                        document.getElementById('content-author').textContent = `by ${frontMatter.metadata.Author} (Annotated by AI)`;

                        let metaHtml = `Originally published ${frontMatter.metadata.Date}.`;
                        if (frontMatter.metadata['Original Source']) {
                            metaHtml += ` <a href="${frontMatter.metadata['Original Source']}" target="_blank" rel="noopener noreferrer" class="text-yellow-500 hover:text-yellow-400 underline">Read the original</a>`;
                        }
                        document.getElementById('content-meta').innerHTML = metaHtml;
                    }

                    marked.use(markedFootnote());
                    contentContainer.innerHTML = marked.parse(frontMatter.content, { breaks: true });
                    setTimeout(setupPopoverEventListeners, 0); // Defer setup to ensure DOM is updated
                } catch (error) {
                    console.error('Failed to load or render markdown:', error);
                    contentContainer.innerHTML = `<p class="text-red-400">Error loading content. Please try again later.</p>`;
                }
            }

            function parseFrontMatter(text) {
                const frontMatterRegex = /^---\s*[\r\n]+([\s\S]*?)[\r\n]+---\s*[\r\n]+/;
                const match = text.match(frontMatterRegex);

                if (!match) {
                    return { metadata: null, content: text };
                }

                const frontMatterBlock = match[1];
                const content = text.slice(match[0].length);

                const metadata = {};
                frontMatterBlock.split('\n').forEach(line => {
                    const parts = line.split(':');
                    if (parts.length >= 2) {
                        const key = parts[0].trim();
                        const value = parts.slice(1).join(':').trim();
                        metadata[key] = value;
                    }
                });

                return { metadata, content };
            }

            function showPopup(element) {
                const footnoteId = element.getAttribute('href').substring(1); // e.g., #fn-1 -> fn-1
                const footnoteElement = document.getElementById(footnoteId);
                if (!footnoteElement) return;

                let annotationHTML = footnoteElement.innerHTML;
                const backlinkIndex = annotationHTML.lastIndexOf('<a');
                if (backlinkIndex !== -1) {
                    annotationHTML = annotationHTML.substring(0, backlinkIndex).trim();
                }

                popup.innerHTML = annotationHTML;
                popup.classList.remove('hidden');
                popup.style.opacity = '1';

                const rect = element.getBoundingClientRect();
                let top = rect.top + window.scrollY - popup.offsetHeight - 10;
                let left = rect.left + window.scrollX + (rect.width / 2) - (popup.offsetWidth / 2);

                if (top < window.scrollY) {
                    top = rect.bottom + window.scrollY + 10;
                }

                if (window.innerWidth < 640) {
                    left = (window.innerWidth - popup.offsetWidth) / 2;
                } else {
                    if (left < 0) left = 10;
                    if (left + popup.offsetWidth > window.innerWidth) {
                        left = window.innerWidth - popup.offsetWidth - 10;
                    }
                }

                popup.style.top = `${top}px`;
                popup.style.left = `${left}px`;
            }

            function hidePopup() {
                if (popup.matches(':hover')) return;
                popup.style.opacity = '0';
                setTimeout(() => popup.classList.add('hidden'), 200);
            }

            function setupPopoverEventListeners() {
                const footnoteLinks = document.querySelectorAll('a[data-footnote-ref]');
                let activePopupElement = null;

                footnoteLinks.forEach(link => {
                    if (isTouchDevice) {
                        link.addEventListener('click', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            if (activePopupElement === link) {
                                hidePopup();
                                activePopupElement = null;
                            } else {
                                if (activePopupElement) hidePopup();
                                showPopup(link);
                                activePopupElement = link;
                            }
                        });
                    } else {
                        link.addEventListener('mouseover', () => {
                            clearTimeout(hideTimeout);
                            showPopup(link);
                        });
                        link.addEventListener('mouseout', () => {
                            hideTimeout = setTimeout(hidePopup, 300);
                        });
                    }
                });

                if (isTouchDevice) {
                    document.body.addEventListener('click', (e) => {
                        if (activePopupElement && !activePopupElement.contains(e.target) && !popup.contains(e.target)) {
                           hidePopup();
                           activePopupElement = null;
                        }
                    }, true);
                } else {
                    popup.addEventListener('mouseover', () => clearTimeout(hideTimeout));
                    popup.addEventListener('mouseout', () => {
                        hideTimeout = setTimeout(hidePopup, 100);
                    });
                }
            }

            loadAndRenderMarkdown();
        });
    </script>
</body>
</html>
